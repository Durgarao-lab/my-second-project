<!DOCTYPE html>
<html>
<head>
    <title>Mechanics Near You</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        #map { height: 90vh; width: 100%; }
        body { margin:0; font-family:Arial, sans-serif; }
        h2 { text-align:center; margin-top:10px; }

        /* Popup Box UI */
        #serviceBox {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 18px;
            border-radius: 8px;
            width: 270px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 9999;
        }
        #overlay {
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5);
            display:none;
            z-index: 9998;
        }
        select, button { width:100%; padding:8px; margin-top:8px; }
    </style>
</head>
<body>

<h2>Mechanics Near You</h2>
<div id="map"></div>

<!-- Popup Overlay -->
<div id="overlay"></div>
<div id="serviceBox">
    <h3>Select Service</h3>
    <select id="serviceSelect">
        <option value="">-- Choose Service --</option>
        <option value="Puncture Fix">Puncture Fix</option>
        <option value="Chain Lubrication">Chain Lubrication</option>
        <option value="Engine Oil Change">Engine Oil Change</option>
        <option value="Bike Wash">Bike Wash</option>
        <option value="Full Service">Full Service</option>
        <option value="Electrical Repair">Electrical Repair</option>
        <option value="Breakdown Assistance">Breakdown Assistance</option>
    </select>
    <button onclick="confirmBooking()">Book Now ðŸš—</button>
    <button onclick="closePopup()" style="background:red;color:white;">Cancel</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let mechanicMarkers = [];
let selectedMechId = null;

navigator.geolocation.getCurrentPosition(initMap, showError);

// ---------------- MAP INIT ----------------
function initMap(pos){
    const userLat = pos.coords.latitude;
    const userLng = pos.coords.longitude;

    map = L.map('map').setView([userLat, userLng], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // USER MARKER
    L.marker([userLat, userLng], {
        icon: L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/25/25694.png",
            iconSize: [35, 35]
        })
    }).addTo(map).bindPopup("<b>You are here</b>").openPopup();

    loadMechanics();
    setInterval(loadMechanics, 10000);
}

// ---------------- LOAD MECHANICS ----------------
function loadMechanics(){
    fetch("/api/mechanics")
    .then(res => res.json())
    .then(data => {
        mechanicMarkers.forEach(m => map.removeLayer(m));
        mechanicMarkers = [];

        data.forEach(m => {
            if(m.lat && m.lng){
                const marker = L.marker([m.lat, m.lng], {
                    icon: L.icon({
                        iconUrl: "https://cdn-icons-png.flaticon.com/512/854/854894.png",
                        iconSize: [40, 40]
                    })
                })
                .addTo(map)
                .bindPopup(`
                    <b>${m.name}</b><br>
                    ðŸ“ž ${m.phone}<br><br>
                    <button onclick="openPopup(${m.id})">ðŸš— Request Mechanic</button>
                `);

                mechanicMarkers.push(marker);
            }
        });
    })
    .catch(err => console.log("Mechanics load error:", err));
}

// ---------------- POPUP BOOKING ----------------
function openPopup(mid){
    selectedMechId = mid;
    document.getElementById("overlay").style.display = "block";
    document.getElementById("serviceBox").style.display = "block";
}

function closePopup(){
    document.getElementById("overlay").style.display = "none";
    document.getElementById("serviceBox").style.display = "none";
}

// ---------------- CONFIRM BOOKING ----------------
function confirmBooking(){
    const service = document.getElementById("serviceSelect").value;

    if(service === ""){
        alert("âš  Please choose a service");
        return;
    }

    // âœ… Book using your Flask route /book_from_map (JSON)
    fetch("/book_from_map", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            service: service,
            mechanic_id: selectedMechId
        })
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === "ok"){
            alert("âœ” Booking Sent Successfully!");
            closePopup();
            window.location.href = "/customer_bookings";
        } else {
            alert("âš  " + (data.message || "Booking failed"));
        }
    })
    .catch(err => {
        console.log(err);
        alert("Server error!");
    });
}

function showError(){
    alert("âš  Please allow GPS to use map!");
}
</script>

</body>
</html>